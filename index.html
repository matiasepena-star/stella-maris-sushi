<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sushi Stella Maris</title>
  <style>
    :root{
      --bg:#0b0b10;
      --bg2:#0f0f16;
      --card:#16161d;
      --card2:#1c1c25;
      --line:#2a2a33;
      --text:#f4f4f8;
      --muted:#b9b9c9;
      --gold:#d8b26b;
      --gold2:#b88b3c;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(216,178,107,.18), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(184,139,60,.12), transparent 60%),
        radial-gradient(900px 700px at 50% 95%, rgba(90,70,30,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      padding-bottom: 130px; /* espacio para barra inferior */
    }

    /* Header */
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 0}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding-top: 6px;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      font-size:26px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(216,178,107,.35);
      background: rgba(20,20,28,.55);
      color: var(--gold);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      font-weight:700;
      white-space:nowrap;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--gold);
      box-shadow:0 0 0 4px rgba(216,178,107,.15);
    }

    /* Tabs */
    .tabs{
      display:flex;gap:10px;flex-wrap:nowrap;overflow:hidden;
      margin:16px 0 10px;
    }
    .tab{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(18,18,26,.58);
      color: var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      min-width: 0;
      flex: 0 0 auto;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tab:active{transform: translateY(1px) scale(.99)}
    .tab.active{
      border-color: rgba(216,178,107,.5);
      background: rgba(216,178,107,.12);
      color: var(--gold);
    }

    .subline{
      margin:10px 2px 14px;
      color: var(--muted);
      font-weight:600;
      line-height:1.35;
    }
    .subline b{color:var(--gold)}
    .subline .mini{
      display:inline-block;margin-left:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,28,.45);
      color:#ddd;
      font-weight:700;
      font-size:12px;
    }

    /* Grid / Cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
    }
    @media (min-width:900px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .media{
      position:relative;
      height:150px; /* m√°s chica para que no se estire cuando metas fotos */
      background:
        radial-gradient(500px 200px at 40% 20%, rgba(216,178,107,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.10));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .media img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .zoomHint{
      position:absolute;left:12px;right:12px;top:10px;
      display:flex;justify-content:center;
      pointer-events:none;
    }
    .zoomHint span{
      font-weight:800;
      font-size:12px;
      color: rgba(255,255,255,.9);
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      padding:7px 10px;
      border-radius:999px;
      backdrop-filter: blur(10px);
    }
    .content{padding:12px 12px 12px}
    .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .title{
      font-weight:900;font-size:18px;line-height:1.05;
    }
    .price{
      color: var(--gold);
      font-weight:950;
      font-size:18px;
      white-space:nowrap;
    }
    .desc{
      margin-top:6px;
      color: var(--muted);
      font-weight:650;
      font-size:13.5px;
      line-height:1.25;
      min-height: 34px;
    }
    .meta{
      margin-top:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,28,.40);
      color: rgba(255,255,255,.9);
      font-weight:900;
      font-size:13px;
      min-width:52px;
      user-select:none;
    }

    /* Buttons (que se sientan presionados) */
    .btn{
      border:0;
      border-radius:16px;
      padding:11px 14px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:active{transform: translateY(2px) scale(.99)}
    .btnAdd{
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(235,235,235,.92));
      color:#111;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      min-width: 120px;
    }
    .btnAdd:hover{filter:brightness(1.02)}
    .btnGhost{
      background: rgba(18,18,26,.45);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }
    .btnGhost:hover{filter:brightness(1.05)}
    .btnGold{
      background: linear-gradient(180deg, rgba(216,178,107,.30), rgba(184,139,60,.22));
      border:1px solid rgba(216,178,107,.35);
      color: var(--gold);
    }
    .btnGold:hover{filter:brightness(1.08)}

    /* Bottom bar */
    .bar{
      position:fixed;left:0;right:0;bottom:0;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(10,10,14,.78);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
    }
    .barInner{
      max-width:980px;margin:0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      align-items:center;
    }
    .totals{
      display:grid;gap:6px;
      font-weight:850;
      color: rgba(255,255,255,.92);
    }
    .totals .mut{color: var(--muted); font-weight:750}
    .includes{
      text-align:right;
      color: rgba(255,255,255,.90);
      font-weight:800;
      line-height:1.2;
    }
    .includes b{color:var(--gold)}
    .chosenBox{
      grid-column:1 / -1;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color: var(--muted);
      font-weight:750;
    }
    .chosenBox .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      border:1px solid rgba(216,178,107,.22);
      background: rgba(216,178,107,.08);
      color: rgba(255,255,255,.9);
      font-weight:850;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .actions{
      grid-column:1 / -1;
      display:grid;
      grid-template-columns: 1fr 1.4fr;
      gap:10px;
    }

    /* Modal */
    .modal{
      position:fixed;inset:0;
      display:none;
      align-items:center;justify-content:center;
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(10px);
      padding:16px;
      z-index:50;
    }
    .modal.open{display:flex}
    .modalCard{
      width:min(720px, 100%);
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(20,20,28,.75);
      box-shadow: 0 26px 80px rgba(0,0,0,.6);
      position:relative;
    }
    .modalCard img{
      width:100%;height:auto;display:block;max-height: 75vh;object-fit:contain;
      background: #0a0a0f;
    }
    .modalClose{
      position:absolute;top:10px;right:10px;
      width:40px;height:40px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color:#fff;font-weight:950;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .modalClose:active{transform:translateY(2px)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Sushi Stella Maris</div>
      <div class="badge" title="Siempre incluida">
        <span class="dot"></span>
        Soja incluida ‚úì
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabCombos" onclick="setTab('combos')">Combos</button>
      <button class="tab" id="tabRolls" onclick="setTab('rolls')">Rolls</button>
      <button class="tab" id="tabSalsas" onclick="setTab('salsas')">Salsas</button>
    </div>

    <div class="subline" id="subline"></div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modalCard">
      <div class="modalClose" onclick="forceCloseModal()">‚úï</div>
      <img id="modalImg" alt="Foto" />
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bar">
    <div class="barInner">
      <div class="totals">
        <div><span class="mut">Total piezas:</span> <span id="totalPieces">0</span></div>
        <div><span class="mut">Total:</span> $ <span id="totalPrice">0</span></div>
      </div>

      <div class="includes">
        Incluye: <b>Wasabi</b> + <b>Pepino</b> + <b>Jengibre</b> + <b>Soja</b>
      </div>

      <div class="chosenBox">
        <div class="chip" id="chosenExtras">Salsas/Adicionales: ‚Äî</div>
        <div class="mut" id="creditsInfo"></div>
      </div>

      <div class="actions">
        <button class="btn btnGhost" onclick="clearAll()">Vaciar</button>
        <button class="btn btnGold" onclick="copyOrder()">Copiar pedido</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  DATA (EDITAR AC√Å)
    // =========================

    // IMPORTANTE: GitHub Pages es sensible a may√∫sculas/min√∫sculas.
    // Us√° EXACTO el nombre del archivo en el repo (ej: philadelphia.PNG).
    const rolls = [
      {
        id:"philadelphia",
        name:"Philadelphia",
        price:9000,
        piecesPerUnit:5,
        img:"philadelphia.PNG",
        desc:"Salm√≥n fresco + queso crema."
      },
      {
        id:"buenos-aires",
        name:"Buenos Aires",
        price:11000,
        piecesPerUnit:5,
        img:"buenos-aires.PNG",
        desc:"Langostino + queso + palta, con salsa BA."
      },
      {
        id:"guacamole",
        name:"Guacamole",
        price:10500,
        piecesPerUnit:5,
        img:"guacamole.PNG",
        desc:"Salm√≥n + queso, topping de guacamole."
      },
    ];

    // Combos (precios seg√∫n tu imagen)
    // credits = cu√°ntas salsas/adicionales "incluye" el combo (adem√°s de soja fija)
    // Regla pedida:
    // 10: 1
    // 15: 1
    // 20: 1
    // 30: 1 y 1 a elecci√≥n  -> 2
    // 40: 2 y 1 a elecci√≥n  -> 3
    // 50: 2 y 2 a elecci√≥n  -> 4
    const combos = [
      { id:"combo10",  name:"Combo 10 piezas",  pieces:10, price:16000, credits:1,
        desc:"Variedad de rolls (selecci√≥n del d√≠a)." },
      { id:"combo15",  name:"Combo 15 piezas",  pieces:15, price:22000, credits:1,
        desc:"Variedad de rolls (selecci√≥n del d√≠a)." },
      { id:"combo20",  name:"Combo 20 piezas",  pieces:20, price:28000, credits:1,
        desc:"Mayor variedad de rolls (selecci√≥n del d√≠a)." },
      { id:"combo30",  name:"Combo 30 piezas",  pieces:30, price:40000, credits:2,
        desc:"Amplia variedad de rolls (selecci√≥n del d√≠a)." },
      { id:"combo40",  name:"Combo 40 piezas",  pieces:40, price:0, credits:3,
        desc:"(Precio a definir) Amplia variedad de rolls." },
      { id:"combo50",  name:"Combo 50 piezas",  pieces:50, price:0, credits:4,
        desc:"(Precio a definir) Amplia variedad de rolls." },
    ].filter(x => x.price > 0); // si todav√≠a no quer√©s mostrar 40/50, quedan ocultos

    // Salsas y adicionales (van de a 1, NO suman piezas)
    const extras = [
      { id:"soja",       name:"Salsa de Soja",      price:850,  type:"salsa" },
      { id:"ba",         name:"Salsa Buenos Aires", price:1300, type:"salsa" },
      { id:"mm",         name:"Salsa Mostaza y Miel", price:1300, type:"salsa" },
      { id:"maracuya",   name:"Salsa Maracuy√°",     price:1500, type:"salsa" },

      { id:"guacExtra",  name:"Guacamole",          price:850,  type:"adicional" },
      { id:"criolla",    name:"Criolla",            price:750,  type:"adicional" },
      { id:"jengibre",   name:"Jengibre",           price:750,  type:"adicional" },
      { id:"pepino",     name:"Pepino",             price:700,  type:"adicional" },
    ];

    // =========================
    //  STATE
    // =========================
    let tab = "combos";
    const cart = {
      combos: new Map(),   // id -> qty
      rolls:  new Map(),   // id -> qty
      extras: new Map(),   // id -> qty
    };

    // =========================
    //  HELPERS
    // =========================
    const money = (n) => (n||0).toLocaleString("es-AR");
    const getRoll = (id) => rolls.find(x=>x.id===id);
    const getCombo = (id) => combos.find(x=>x.id===id);
    const getExtra = (id) => extras.find(x=>x.id===id);

    function includedCredits(){
      let c = 0;
      for (const [id, qty] of cart.combos.entries()){
        const combo = getCombo(id);
        if (combo) c += (combo.credits||0) * qty;
      }
      return c;
    }

    function extrasCount(){
      let n = 0;
      for (const [, qty] of cart.extras.entries()) n += qty;
      return n;
    }

    function extrasIncludedApplied(){
      // los primeros "credits" extras se descuentan (quedan $0)
      return Math.min(includedCredits(), extrasCount());
    }

    function extrasPaidCount(){
      return Math.max(0, extrasCount() - includedCredits());
    }

    // =========================
    //  RENDER
    // =========================
    function setTab(next){
      tab = next;
      document.getElementById("tabCombos").classList.toggle("active", tab==="combos");
      document.getElementById("tabRolls").classList.toggle("active", tab==="rolls");
      document.getElementById("tabSalsas").classList.toggle("active", tab==="salsas");
      render();
    }

    function render(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      const sub = document.getElementById("subline");
      if (tab==="rolls"){
        sub.innerHTML = `Cada roll es <b>x5</b> piezas. <span class="mini">Tocar foto para agrandar</span>`;
      } else if (tab==="combos"){
        sub.innerHTML = `Soja incluida. Wasabi + pepino + jengibre incluidos. <b>Salsas/adicionales</b> extra seg√∫n combo. <span class="mini">Los ‚Äúincluidos‚Äù se descuentan al agregar en Salsas</span>`;
      } else {
        const c = includedCredits();
        sub.innerHTML = `Salsas y adicionales van de a <b>1</b> (no suman piezas). <span class="mini">Incluidos por combos: ${c}</span>`;
      }

      if (tab==="rolls"){
        rolls.forEach(item => grid.appendChild(renderRollCard(item)));
      }
      if (tab==="combos"){
        combos.forEach(item => grid.appendChild(renderComboCard(item)));
      }
      if (tab==="salsas"){
        extras.forEach(item => grid.appendChild(renderExtraCard(item)));
      }

      renderBottom();
    }

    function renderRollCard(item){
      const el = document.createElement("div");
      el.className = "card";

      el.innerHTML = `
        <div class="media" onclick="openModal('${escapeQuotes(item.img)}')">
          <div class="zoomHint"><span>Tocar para agrandar</span></div>
          <img src="${escapeHtml(item.img)}" alt="${escapeHtml(item.name)}" onerror="this.style.display='none'"/>
        </div>
        <div class="content">
          <div class="row1">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="price">$ ${money(item.price)}</div>
          </div>
          <div class="desc">${escapeHtml(item.desc)}</div>
          <div class="meta">
            <div class="pill">x5</div>
            <button class="btn btnAdd" onclick="addRoll('${escapeQuotes(item.id)}')">+ Agregar</button>
          </div>
        </div>
      `;
      return el;
    }

    function comboIncludeText(combo){
      // texto EXACTO con la regla que pediste (soja fija siempre)
      if (combo.pieces===10) return "Incluye: Soja fija + 1 salsa/adicional a elecci√≥n.";
      if (combo.pieces===15) return "Incluye: Soja fija + 1 salsa/adicional a elecci√≥n.";
      if (combo.pieces===20) return "Incluye: Soja fija + 1 salsa/adicional a elecci√≥n.";
      if (combo.pieces===30) return "Incluye: Soja fija + 1 + 1 a elecci√≥n.";
      if (combo.pieces===40) return "Incluye: Soja fija + 2 + 1 a elecci√≥n.";
      if (combo.pieces===50) return "Incluye: Soja fija + 2 + 2 a elecci√≥n.";
      return `Incluye: Soja fija + ${combo.credits||0} salsa/adicional.`;
    }

    function renderComboCard(item){
      const el = document.createElement("div");
      el.className = "card";

      el.innerHTML = `
        <div class="media" style="display:flex;align-items:center;justify-content:center;">
          <div style="text-align:center;">
            <div style="font-weight:950;font-size:22px;color:rgba(255,255,255,.9)">${item.pieces} piezas</div>
            <div style="margin-top:4px;font-weight:900;color:var(--gold)">Combo</div>
          </div>
        </div>
        <div class="content">
          <div class="row1">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="price">$ ${money(item.price)}</div>
          </div>
          <div class="desc">${escapeHtml(item.desc)}<br><span style="color:rgba(255,255,255,.9);font-weight:800">${escapeHtml(comboIncludeText(item))}</span></div>
          <div class="meta">
            <div class="pill">${item.pieces} piezas</div>
            <button class="btn btnAdd" onclick="addCombo('${escapeQuotes(item.id)}')">+ Agregar</button>
          </div>
        </div>
      `;
      return el;
    }

    function renderExtraCard(item){
      const el = document.createElement("div");
      el.className = "card";

      // No usamos imagen ac√° (as√≠ evitamos ‚Äúdos fotos‚Äù y queda liviano).
      // Si despu√©s quer√©s mini √≠conos/fotos, lo agregamos.
      el.innerHTML = `
        <div class="media" style="height:120px;display:flex;align-items:center;justify-content:center;">
          <div style="text-align:center; padding:0 10px;">
            <div style="font-weight:950;font-size:18px;color:rgba(255,255,255,.95)">${escapeHtml(item.name)}</div>
            <div style="margin-top:6px;font-weight:900;color:var(--gold)">$ ${money(item.price)}</div>
            <div style="margin-top:8px;color:var(--muted);font-weight:750;font-size:12px">${item.type==="salsa" ? "Salsa (x1)" : "Adicional (x1)"}</div>
          </div>
        </div>
        <div class="content">
          <div class="meta">
            <button class="btn btnGhost" onclick="removeExtra('${escapeQuotes(item.id)}')">‚àí</button>
            <div class="pill" id="qty_${escapeHtml(item.id)}">${cart.extras.get(item.id)||0}</div>
            <button class="btn btnAdd" onclick="addExtra('${escapeQuotes(item.id)}')">+ Agregar</button>
          </div>
          <div class="desc" style="min-height:auto;margin-top:10px">
            ${extrasPriceNote()}
          </div>
        </div>
      `;
      return el;
    }

    function extrasPriceNote(){
      const c = includedCredits();
      if (c<=0) return "Si sum√°s combos, algunas salsas/adicionales pueden quedar incluidas.";
      const used = extrasIncludedApplied();
      const left = Math.max(0, c - extrasCount());
      return `Incluidos por combos: <b style="color:var(--gold)">${c}</b>. Usados: <b style="color:var(--gold)">${used}</b>. Restan: <b style="color:var(--gold)">${left}</b>.`;
    }

    function renderBottom(){
      const pieces = totalPieces();
      const price = totalPrice();

      document.getElementById("totalPieces").textContent = pieces;
      document.getElementById("totalPrice").textContent  = money(price);

      // Mostrar qu√© salsas/adicionales eligieron
      const chosen = [];
      for (const [id, qty] of cart.extras.entries()){
        if (qty<=0) continue;
        const ex = getExtra(id);
        if (!ex) continue;
        chosen.push(`${qty}x ${ex.name}`);
      }
      document.getElementById("chosenExtras").textContent = chosen.length ? `Salsas/Adicionales: ${chosen.join(" ¬∑ ")}` : "Salsas/Adicionales: ‚Äî";

      // Info cr√©ditos
      const c = includedCredits();
      if (c>0){
        const used = extrasIncludedApplied();
        const left = Math.max(0, c - extrasCount());
        document.getElementById("creditsInfo").textContent = `Incluidos: ${c} ¬∑ Usados: ${used} ¬∑ Restan: ${left}`;
      } else {
        document.getElementById("creditsInfo").textContent = "";
      }

      // actualizar cantidades en cards de salsas si est√°s en esa tab
      if (tab==="salsas"){
        extras.forEach(e=>{
          const box = document.getElementById("qty_"+e.id);
          if (box) box.textContent = cart.extras.get(e.id)||0;
        });
      }
    }

    // =========================
    //  CART OPS
    // =========================
    function addRoll(id){
      cart.rolls.set(id, (cart.rolls.get(id)||0)+1);
      renderBottom();
    }
    function addCombo(id){
      cart.combos.set(id, (cart.combos.get(id)||0)+1);
      renderBottom();
    }
    function addExtra(id){
      cart.extras.set(id, (cart.extras.get(id)||0)+1);
      render();
    }
    function removeExtra(id){
      const cur = cart.extras.get(id)||0;
      if (cur<=0) return;
      if (cur===1) cart.extras.delete(id);
      else cart.extras.set(id, cur-1);
      render();
    }

    function clearAll(){
      cart.combos.clear();
      cart.rolls.clear();
      cart.extras.clear();
      render();
    }

    function totalPieces(){
      let p = 0;
      for (const [id, qty] of cart.rolls.entries()){
        const r = getRoll(id);
        if (r) p += (r.piecesPerUnit||0) * qty;
      }
      for (const [id, qty] of cart.combos.entries()){
        const c = getCombo(id);
        if (c) p += (c.pieces||0) * qty;
      }
      return p;
    }

    function totalPrice(){
      let t = 0;
      for (const [id, qty] of cart.rolls.entries()){
        const r = getRoll(id);
        if (r) t += (r.price||0) * qty;
      }
      for (const [id, qty] of cart.combos.entries()){
        const c = getCombo(id);
        if (c) t += (c.price||0) * qty;
      }

      // Extras: los primeros "credits" quedan incluidos ($0)
      const allExtras = [];
      for (const [id, qty] of cart.extras.entries()){
        const ex = getExtra(id);
        if (!ex) continue;
        for (let i=0;i<qty;i++) allExtras.push(ex);
      }

      const credits = includedCredits();
      // descuento (incluidos) aplicado a los m√°s caros o a los primeros?
      // Para que no te ‚Äúduela‚Äù, aplico el incluido a los m√°s caros primero.
      allExtras.sort((a,b)=> (b.price||0)-(a.price||0));

      let paid = allExtras;
      if (credits>0) paid = allExtras.slice(credits); // los primeros credits quedan 0

      for (const ex of paid){
        t += (ex.price||0);
      }

      return t;
    }

    // =========================
    //  COPY ORDER
    // =========================
    function copyOrder(){
      const lines = [];
      lines.push("Hola Stella Maris Sushi üç£");
      lines.push("");
      lines.push("Quiero pedir:");
      lines.push("");

      // Sushi
      const sushiLines = [];

      // Rolls: mostrar ‚Äúx5 ‚Äì N piezas‚Äù
      for (const [id, qty] of cart.rolls.entries()){
        const r = getRoll(id);
        if (!r || qty<=0) continue;
        const pieces = qty * (r.piecesPerUnit||0);
        sushiLines.push(`üç£ Sushi:`);
        break;
      }
      // si no hay rolls pero hay combos, igual mostramos Sushi:
      if (!sushiLines.length && cart.combos.size>0) sushiLines.push("üç£ Sushi:");

      // rolls
      for (const [id, qty] of cart.rolls.entries()){
        const r = getRoll(id);
        if (!r || qty<=0) continue;
        const pieces = qty * (r.piecesPerUnit||0);
        sushiLines.push(`${qty}x ${r.name} x5 ‚Äì ${pieces} piezas`);
      }
      // combos
      for (const [id, qty] of cart.combos.entries()){
        const c = getCombo(id);
        if (!c || qty<=0) continue;
        const pieces = qty * (c.pieces||0);
        sushiLines.push(`${qty}x ${c.name} ‚Äì ${pieces} piezas`);
      }

      // Salsas y adicionales
      const extraLines = [];
      for (const [id, qty] of cart.extras.entries()){
        const ex = getExtra(id);
        if (!ex || qty<=0) continue;
        extraLines.push(`${qty}x ${ex.name}`);
      }

      lines.push(...sushiLines);

      if (extraLines.length){
        lines.push("");
        lines.push("ü•£ Salsas y adicionales:");
        lines.push(...extraLines);
      }

      lines.push("");
      lines.push(`Total de piezas: ${totalPieces()}`);
      lines.push(`Total: $ ${money(totalPrice())}`);
      lines.push("");
      lines.push("Retiro en el local.");

      const txt = lines.join("\n");

      navigator.clipboard.writeText(txt).then(()=>{
        alert("Pedido copiado ‚úÖ");
      }).catch(()=>{
        prompt("Copi√° el pedido:", txt);
      });
    }

    // =========================
    //  MODAL
    // =========================
    function openModal(src){
      if (!src) return;
      const img = document.getElementById("modalImg");
      img.src = src;
      document.getElementById("modal").classList.add("open");
    }
    function closeModal(e){
      if (e.target && e.target.id === "modal"){
        document.getElementById("modal").classList.remove("open");
      }
    }
    function forceCloseModal(){
      document.getElementById("modal").classList.remove("open");
    }

    // =========================
    //  SAFE STRING
    // =========================
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeQuotes(s){
      return String(s||"").replaceAll("'","\\'");
    }

    // init
    render();
  </script>
</body>
</html>
