<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sushi Stella Maris</title>

<style>
  :root{
    --bg:#0b0b0c;
    --panel:#101114;
    --card:#15161a;
    --line:#262830;
    --text:#f3f3f3;
    --muted:#b7b7b7;
    --gold:#caa76a;
    --gold2:#8f6f3f;
    --shadow: 0 18px 55px rgba(0,0,0,.55);
    --radius:18px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 700px at 50% -10%, rgba(202,167,106,.18), transparent 55%),
      radial-gradient(900px 550px at 20% 20%, rgba(255,255,255,.06), transparent 52%),
      var(--bg);
    color:var(--text);
  }

  header{
    position:fixed; top:0; left:0; right:0;
    z-index:1000;
    background: rgba(15,16,18,.92);
    backdrop-filter: blur(12px);
    border-bottom:1px solid rgba(255,255,255,.08);
    padding:14px 14px 12px;
  }
  .wrap{max-width:720px; margin:0 auto;}
  .brandRow{display:flex; align-items:center; gap:12px;}
  .logo{
    width:40px; height:40px; border-radius:14px;
    display:grid; place-items:center;
    color:var(--gold);
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 40%),
      linear-gradient(135deg, rgba(202,167,106,.28), rgba(202,167,106,.08));
    border:1px solid rgba(202,167,106,.25);
    user-select:none;
  }
  h1{margin:0; font-size:18px; letter-spacing:.2px; font-weight:950;}

  .tabs{
    margin-top:12px;
    display:flex;
    gap:10px;
    flex-wrap:nowrap;
  }
  .tab{
    flex:1;
    text-align:center;
    padding:11px 10px;
    border-radius:14px;
    cursor:pointer;
    font-size:14px;
    font-weight:900;
    color: rgba(255,255,255,.90);
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    user-select:none;
    transition: transform .08s ease, background .15s ease, border-color .15s ease, filter .15s ease, box-shadow .15s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .tab:active{
    transform: translateY(2px) scale(.98);
    filter:brightness(.92);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.45);
  }
  .tab.active{
    background: rgba(202,167,106,.16);
    border-color: rgba(202,167,106,.40);
    color:#fff;
  }

  .content{
    max-width:720px;
    margin:0 auto;
    padding: 120px 14px 150px;
  }

  .sectionTitle{
    margin: 10px 2px 10px;
    color: var(--gold);
    letter-spacing:.35em;
    font-weight:950;
    font-size: 12px;
    text-transform: uppercase;
  }

  .grid{
    display:grid;
    gap:14px;
    grid-template-columns: 1fr;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
    position:relative;
  }

  /* Imagen: sin estirar + se ve toda (incluye texto de la foto) */
  .imgBox{
    height: 250px; /* Rolls */
    background:
      radial-gradient(220px 140px at 20% 20%, rgba(202,167,106,.14), transparent 60%),
      radial-gradient(220px 140px at 80% 0%, rgba(255,255,255,.06), transparent 60%),
      rgba(0,0,0,.30);
    border-bottom:1px solid rgba(255,255,255,.06);
    display:flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.35);
    font-weight:900;
    letter-spacing:.08em;
    position:relative;
  }
  .imgBox img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
    background: rgba(0,0,0,.55);
  }

  .tapHint{
    position:absolute;
    top:10px; left:10px;
    font-size:12px;
    font-weight:950;
    color: rgba(255,255,255,.88);
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.12);
    padding:6px 10px;
    border-radius: 999px;
    letter-spacing:.02em;
    pointer-events:none;
  }

  /* Combos y Salsas: imagen un poco mÃ¡s baja */
  .card[data-tab="combos"] .imgBox,
  .card[data-tab="extras"] .imgBox{
    height: 200px;
  }

  .priceTag{
    position:absolute;
    top:12px; right:12px;
    background: rgba(0,0,0,.60);
    border:1px solid rgba(255,255,255,.12);
    padding:7px 12px;
    border-radius:999px;
    font-weight:1000;
    letter-spacing:.3px;
    z-index:2;
  }

  .body{ padding: 12px 14px 14px; }
  .name{margin:0; font-size:18px; font-weight:1000; line-height:1.15;}
  .meta{margin-top:6px; font-size:13px; color:var(--muted); line-height:1.25;}
  .meta b{color: rgba(255,255,255,.92); font-weight:950;}
  .list{
    margin:10px 0 0;
    padding-left: 18px;
    color: rgba(255,255,255,.78);
    font-size: 13px;
    line-height:1.35;
  }

  .bottomRow{
    margin-top:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,.08);
  }

  .qty{
    display:flex; align-items:center; gap:10px;
    font-size:13px;
    color: var(--muted);
    font-weight:900;
  }
  .qtyPill{
    padding:7px 11px;
    border-radius:999px;
    border:1px solid rgba(202,167,106,.28);
    background: rgba(202,167,106,.10);
    color:#fff;
    min-width:52px;
    text-align:center;
    font-weight:1000;
  }

  .btns{display:flex; gap:10px;}
  .btn{
    border:none;
    cursor:pointer;
    user-select:none;
    font-weight:1000;
    padding:12px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    color:#fff;
    transition: transform .08s ease, filter .15s ease, background .15s ease, box-shadow .15s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{
    transform: translateY(2px) scale(.97);
    filter: brightness(.92);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.45);
  }
  .btn.add{
    background: linear-gradient(180deg, rgba(202,167,106,.95), rgba(143,111,63,.95));
    border:1px solid rgba(202,167,106,.55);
    color:#1a140b;
  }
  .btn.minus{ background: rgba(255,255,255,.04); }

  .footer{
    position:fixed; left:0; right:0; bottom:0;
    z-index:1000;
    background: rgba(10,10,12,.88);
    backdrop-filter: blur(12px);
    border-top:1px solid rgba(255,255,255,.10);
    padding:10px 12px;
  }
  .footerInner{
    max-width:720px;
    margin:0 auto;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }

  .totals{
    display:flex;
    flex-direction:column;
    gap:4px;
    padding:10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    width: 100%;
  }
  .totals .big{font-weight:1000; font-size:16px;}
  .totals .small{color:var(--muted); font-weight:900; font-size:13px;}
  .totals .third{color:rgba(255,255,255,.78); font-weight:900; font-size:13px;}

  .footerBtns{
    width:100%;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .btnGhost{
    flex:0 0 auto;
    padding:12px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    color:#fff;
    font-weight:1000;
    cursor:pointer;
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btnGhost:active{
    transform: translateY(2px) scale(.97);
    filter:brightness(.92);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.45);
  }
  .btnWA{
    flex:1;
    padding:12px 16px;
    border-radius: 14px;
    background: linear-gradient(180deg, rgba(202,167,106,.95), rgba(143,111,63,.95));
    border:1px solid rgba(202,167,106,.55);
    color:#1a140b;
    font-weight:1100;
    cursor:pointer;
    text-align:center;
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btnWA:active{
    transform: translateY(2px) scale(.97);
    filter:brightness(.92);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.35);
  }

  /* ===== MODAL (imagen grande + selector salsas) ===== */
  .modal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.70);
    backdrop-filter: blur(6px);
    z-index:2000;
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal.show{display:flex;}
  .modalCard{
    width:min(720px, 100%);
    background: rgba(15,16,18,.92);
    border:1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow:hidden;
    position:relative;
  }
  .modalTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:12px 14px;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .modalTitle{
    font-weight:1000;
    letter-spacing:.2px;
    font-size:14px;
    color:#fff;
  }
  .xBtn{
    width:38px; height:38px;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color:#fff;
    font-size:18px;
    font-weight:1000;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
  }
  .xBtn:active{
    transform: translateY(2px) scale(.97);
    filter:brightness(.92);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.45);
  }

  .modalBody{ padding:14px; }
  .imgBig{
    width:100%;
    background: rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 14px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .imgBig img{
    width:100%;
    height:auto;
    max-height: 70vh;
    object-fit: contain;
    display:block;
  }

  .chooserHint{
    margin-top:10px;
    color: rgba(255,255,255,.82);
    font-weight:950;
    font-size:13px;
  }
  .chooserSub{
    margin-top:4px;
    color: var(--muted);
    font-weight:900;
    font-size:12.5px;
  }
  .choices{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .choiceBtn{
    padding:12px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color:#fff;
    font-weight:1000;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
  }
  .choiceBtn:active{
    transform: translateY(2px) scale(.97);
    filter:brightness(.92);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.45);
  }
  .pillRow{
    margin-top:12px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(202,167,106,.28);
    background: rgba(202,167,106,.10);
    color:#fff;
    font-weight:950;
    font-size:12.5px;
  }

</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brandRow">
      <div class="logo">âœ¦</div>
      <div>
        <h1>Sushi Stella Maris</h1>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="setTab('combos', this)">Combos</div>
      <div class="tab" onclick="setTab('rolls', this)">Rolls</div>
      <div class="tab" onclick="setTab('extras', this)">Salsas</div>
    </div>
  </div>
</header>

<div class="content" id="content"></div>

<div class="footer">
  <div class="footerInner">
    <div class="totals">
      <div class="big" id="totalMoney">Total: $0</div>
      <div class="small" id="totalPieces">Total de piezas: 0</div>
      <div class="third" id="countExtras">Salsas y adicionales: 0</div>
    </div>
    <div class="footerBtns">
      <button class="btnGhost" id="btnClear">Vaciar</button>
      <button class="btnWA" id="btnWA">Confirmar por WhatsApp</button>
    </div>
  </div>
</div>

<!-- Modal Imagen -->
<div class="modal" id="imgModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalTop">
      <div class="modalTitle" id="imgModalTitle">Imagen</div>
      <button class="xBtn" onclick="closeImgModal()">Ã—</button>
    </div>
    <div class="modalBody">
      <div class="imgBig">
        <img id="imgModalImg" src="" alt="">
      </div>
    </div>
  </div>
</div>

<!-- Modal Selector Salsas a elecciÃ³n -->
<div class="modal" id="sauceModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalTop">
      <div class="modalTitle" id="sauceModalTitle">ElegÃ­ tu salsa</div>
      <button class="xBtn" onclick="cancelSaucePick()">Ã—</button>
    </div>
    <div class="modalBody">
      <div class="chooserHint" id="sauceHint">ElegÃ­ 1 salsa</div>
      <div class="chooserSub">Opciones</div>
      <div class="choices" id="sauceChoices"></div>

      <div class="pillRow" id="pickedPills" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
  const WA = "5491164194866";

  const fmtMoney = (n) => {
    const x = Math.round(Number(n)||0);
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  };

  let activeTab = "combos";
  const cart = {}; // id -> qty

  // ====== NUEVO: seguimiento por combo (para salsas incluidas y a elecciÃ³n) ======
  // comboInstances[id] = [ ["Salsa Buenos Aires","Salsa de soja"], ["Salsa maracuyÃ¡", ...] ] (1 array por combo agregado)
  const comboInstances = {}; // solo para items tab:"combos"

  // Reglas combos (soja fija + salsas a elecciÃ³n)
  const COMBO_RULES = {
    combo10: { soy: 1, choice: 0 },
    combo15: { soy: 1, choice: 0 },
    combo20: { soy: 1, choice: 0 },
    combo30: { soy: 1, choice: 1 },
    combo40: { soy: 2, choice: 1 },
    combo50: { soy: 2, choice: 2 }
  };

  // Opciones permitidas para "a elecciÃ³n"
  const SAUCE_OPTIONS = [
    "Salsa Buenos Aires",
    "Salsa maracuyÃ¡",
    "Salsa mostaza y miel",
    "Salsa de soja"
  ];

  // MenÃº (completÃ¡s despuÃ©s; dejo lo que ya tenÃ­as)
  const MENU = [
    // ===== Combos =====
    { id:"combo10", tab:"combos", name:"Combo 10 piezas", pieces:10, price:16000, composition:["4 Philadelphia","3 New York","3 California"], img:"" },
    { id:"combo15", tab:"combos", name:"Combo 15 piezas", pieces:15, price:22000, composition:["5 New York","5 California","5 Buenos Aires"], img:"" },
    { id:"combo20", tab:"combos", name:"Combo 20 piezas", pieces:20, price:30000, composition:["5 Alaska","5 Vegetariano","5 Maki de atÃºn","5 Cheese salmÃ³n"], img:"" },
    { id:"combo30", tab:"combos", name:"Combo 30 piezas", pieces:30, price:45000, composition:["5 New York","5 Buenos Aires","5 Vegetariano","5 Makis de salmÃ³n","5 Avocado","5 California"], img:"" },
    { id:"combo40", tab:"combos", name:"Combo 40 piezas", pieces:40, price:55000, composition:["10 Philadelphia","10 Maki de salmÃ³n","10 Niguiris de salmÃ³n","10 New York"], img:"" },
    { id:"combo50", tab:"combos", name:"Combo 50 piezas", pieces:50, price:70000, composition:["10 Ebi langostino","10 Crazy","10 SalmÃ³n crispy","10 Tamago","10 Keki"], img:"" },

    // ===== Rolls (x5) =====
    { id:"philadelphia", tab:"rolls", name:"Philadelphia", pieces:5, price:9000, desc:"SalmÃ³n fresco + queso crema.", img:"philadelphia.PNG" },
    { id:"buenos_aires", tab:"rolls", name:"Buenos Aires", pieces:5, price:11000, desc:"Langostino + queso + palta, con salsa BA.", img:"buenos-aires.PNG" },
    { id:"guacamole_roll", tab:"rolls", name:"Guacamole", pieces:5, price:10500, desc:"SalmÃ³n + queso crema con topping de guacamole.", img:"guacamole.PNG" },
    { id:"newyork", tab:"rolls", name:"New York", pieces:5, price:9000, desc:"(completÃ¡s ingredientes).", img:"" },
    { id:"california", tab:"rolls", name:"California", pieces:5, price:8500, desc:"(completÃ¡s ingredientes).", img:"" },
    { id:"vegetariano", tab:"rolls", name:"Vegetariano", pieces:5, price:7500, desc:"Zanahoria + palta + queso.", img:"" },

    // ===== Salsas/Adicionales (unidad) =====
    { id:"soja", tab:"extras", name:"Salsa de soja", pieces:0, price:850, desc:"Unidad.", img:"salsa-de-soja.PNG" },
    { id:"salsa_ba", tab:"extras", name:"Salsa Buenos Aires", pieces:0, price:1300, desc:"Unidad.", img:"salsa -buenos-aires.PNG" },
    { id:"mostaza_miel", tab:"extras", name:"Salsa mostaza y miel", pieces:0, price:1300, desc:"Unidad.", img:"salsa-de-mostaza-y-miel.PNG" },
    { id:"maracuya", tab:"extras", name:"Salsa maracuyÃ¡", pieces:0, price:1500, desc:"Unidad.", img:"salsa-de-maracuya.PNG" },

    // Si querÃ©s mantener â€œGuacamoleâ€ como adicional aparte del roll:
    { id:"guacamole_extra", tab:"extras", name:"Guacamole (adicional)", pieces:0, price:850, desc:"Unidad.", img:"guacamole .PNG" },

    { id:"criolla", tab:"extras", name:"Criolla", pieces:0, price:750, desc:"Unidad.", img:"criolla.PNG" },
    { id:"jengibre", tab:"extras", name:"Jengibre", pieces:0, price:750, desc:"Unidad.", img:"jengibre .PNG" },
    { id:"pepino", tab:"extras", name:"Pepino", pieces:0, price:700, desc:"Unidad.", img:"pepino.PNG" }
  ];

  const getQty = (id) => cart[id] || 0;

  function haptic() {
    try { if (navigator.vibrate) navigator.vibrate(12); } catch(e){}
  }

  function setTab(tab, el){
    activeTab = tab;
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");
    render();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // ===== Modal Imagen =====
  function openImgModal(title, src){
    if(!src) return;
    document.getElementById("imgModalTitle").textContent = title || "Imagen";
    const img = document.getElementById("imgModalImg");
    img.src = src;
    img.alt = title || "";
    document.getElementById("imgModal").classList.add("show");
    document.getElementById("imgModal").setAttribute("aria-hidden","false");
  }
  function closeImgModal(){
    document.getElementById("imgModal").classList.remove("show");
    document.getElementById("imgModal").setAttribute("aria-hidden","true");
    const img = document.getElementById("imgModalImg");
    img.src = "";
    img.alt = "";
  }
  document.getElementById("imgModal").addEventListener("click", (e)=>{
    if(e.target.id === "imgModal") closeImgModal();
  });

  // ===== Selector salsas a elecciÃ³n (combos) =====
  let saucePick = null;
  // saucePick = { comboId, remaining, picked: [], onDone: fn, onCancel: fn }
  function startSaucePick(comboId, needed, onDone, onCancel){
    saucePick = { comboId, remaining: needed, picked: [], onDone, onCancel };
    updateSauceModalUI();
    document.getElementById("sauceModal").classList.add("show");
    document.getElementById("sauceModal").setAttribute("aria-hidden","false");
  }
  function updateSauceModalUI(){
    if(!saucePick) return;
    const item = MENU.find(x=>x.id===saucePick.comboId);
    const title = item ? item.name : "Combo";
    document.getElementById("sauceModalTitle").textContent = `Salsa a elecciÃ³n Â· ${title}`;
    document.getElementById("sauceHint").textContent =
      saucePick.remaining === 1 ? "ElegÃ­ 1 salsa" : `ElegÃ­ ${saucePick.remaining} salsas`;

    const choices = document.getElementById("sauceChoices");
    choices.innerHTML = SAUCE_OPTIONS.map(name => {
      return `<button class="choiceBtn" onclick="pickSauce('${escapeQuotes(name)}')">${name}</button>`;
    }).join("");

    const pills = document.getElementById("pickedPills");
    if(saucePick.picked.length){
      pills.style.display = "flex";
      pills.innerHTML = saucePick.picked.map(x=>`<span class="pill">${x}</span>`).join("");
    }else{
      pills.style.display = "none";
      pills.innerHTML = "";
    }
  }
  function escapeQuotes(s){
    return String(s).replace(/'/g,"\\'");
  }
  function pickSauce(name){
    if(!saucePick) return;
    haptic();
    saucePick.picked.push(name);
    saucePick.remaining -= 1;

    if(saucePick.remaining <= 0){
      const picked = saucePick.picked.slice();
      const done = saucePick.onDone;
      closeSauceModal();
      done(picked);
      return;
    }
    updateSauceModalUI();
  }
  function closeSauceModal(){
    document.getElementById("sauceModal").classList.remove("show");
    document.getElementById("sauceModal").setAttribute("aria-hidden","true");
    saucePick = null;
  }
  function cancelSaucePick(){
    if(!saucePick) { closeSauceModal(); return; }
    const cancel = saucePick.onCancel;
    closeSauceModal();
    if (typeof cancel === "function") cancel();
  }
  document.getElementById("sauceModal").addEventListener("click", (e)=>{
    if(e.target.id === "sauceModal") cancelSaucePick();
  });

  // ===== Carrito =====
  function add(id){
    const item = MENU.find(x => x.id === id);
    if(!item) return;

    // Si es combo y tiene salsas a elecciÃ³n -> pedirlas antes de sumar
    if(item.tab === "combos"){
      const rule = COMBO_RULES[id] || { soy:0, choice:0 };
      if(rule.choice > 0){
        startSaucePick(
          id,
          rule.choice,
          (pickedSauces) => {
            // confirmar el combo + guardar elecciones
            cart[id] = (cart[id]||0) + 1;
            if(!comboInstances[id]) comboInstances[id] = [];
            comboInstances[id].push(pickedSauces);
            haptic();
            updateTotals();
            updateQtyPills();
          },
          () => {
            // cancelado: no se agrega el combo
          }
        );
        return;
      } else {
        // combo sin elecciÃ³n
        cart[id] = (cart[id]||0) + 1;
        if(!comboInstances[id]) comboInstances[id] = [];
        comboInstances[id].push([]); // instancia sin elecciÃ³n
        haptic();
        updateTotals();
        updateQtyPills();
        return;
      }
    }

    // resto items
    cart[id] = (cart[id]||0) + 1;
    haptic();
    updateTotals();
    updateQtyPills();
  }

  function sub(id){
    if (!cart[id]) return;

    const item = MENU.find(x => x.id === id);
    cart[id] -= 1;
    if (cart[id] <= 0) delete cart[id];

    // si es combo, borrar UNA instancia de elecciones
    if(item && item.tab === "combos"){
      if(comboInstances[id] && comboInstances[id].length){
        comboInstances[id].pop();
      }
      if(comboInstances[id] && comboInstances[id].length === 0){
        delete comboInstances[id];
      }
    }

    haptic();
    updateTotals();
    updateQtyPills();
  }

  function clearCart(){
    if (Object.keys(cart).length === 0) return;
    if (!confirm("Â¿Vaciar el pedido?")) return;
    for (const k of Object.keys(cart)) delete cart[k];
    for (const k of Object.keys(comboInstances)) delete comboInstances[k];
    updateTotals();
    render();
  }

  // ===== Totales + conteos salsas =====
  function totals(){
    let totalMoney = 0;
    let totalPieces = 0;

    for (const [id, qty] of Object.entries(cart)){
      const item = MENU.find(x => x.id === id);
      if (!item) continue;
      totalMoney += (item.price||0) * qty;
      totalPieces += (item.pieces||0) * qty;
    }
    return { totalMoney, totalPieces };
  }

  function countIncludedSoja(){
    // soja fija por combos
    let count = 0;
    for (const [comboId, instances] of Object.entries(comboInstances)){
      const rule = COMBO_RULES[comboId] || { soy:0, choice:0 };
      count += (instances.length * (rule.soy||0));
    }
    return count;
  }

  function countChoiceSauces(){
    // total de salsas elegidas (sin cargo)
    let count = 0;
    for (const instances of Object.values(comboInstances)){
      for (const arr of instances){
        count += (arr ? arr.length : 0);
      }
    }
    return count;
  }

  function countPaidExtras(){
    // items tab extras (pieces == 0) del carrito
    let count = 0;
    for (const [id, qty] of Object.entries(cart)){
      const item = MENU.find(x=>x.id===id);
      if(item && item.pieces === 0){
        count += qty;
      }
    }
    return count;
  }

  function updateTotals(){
    const { totalMoney, totalPieces } = totals();
    document.getElementById("totalMoney").textContent = `Total: $${fmtMoney(totalMoney)}`;
    document.getElementById("totalPieces").textContent = `Total de piezas: ${totalPieces}`;

    // ====== NUEVO (4): solo nÃºmero ======
    const saucesAndExtrasCount = countIncludedSoja() + countChoiceSauces() + countPaidExtras();
    document.getElementById("countExtras").textContent = `Salsas y adicionales: ${saucesAndExtrasCount}`;
  }

  function updateQtyPills(){
    MENU.forEach(item => {
      const pill = document.getElementById("qty-"+item.id);
      if (!pill) return;
      pill.textContent = (getQty(item.id)) + "x";
    });
  }

  // ====== NUEVO (5): Mensaje WA con secciones de salsas ======
  function groupChoiceSauces(){
    // devuelve { "Salsa Buenos Aires": 2, ... }
    const m = {};
    for (const instances of Object.values(comboInstances)){
      for (const arr of instances){
        (arr||[]).forEach(name=>{
          m[name] = (m[name]||0) + 1;
        });
      }
    }
    return m;
  }

  function groupPaidExtras(){
    // devuelve lista {name, qty, unit, total}
    const extras = Object.entries(cart)
      .map(([id, qty]) => ({qty, item: MENU.find(x=>x.id===id)}))
      .filter(x => x.item && x.item.pieces === 0)
      .sort((a,b)=> a.item.name.localeCompare(b.item.name))
      .map(x => ({
        name: x.item.name,
        qty: x.qty,
        unit: Number(x.item.price||0),
        total: Number(x.item.price||0) * x.qty
      }));
    return extras;
  }

  function buildMessage(){
    const sushiLines = [];
    let totalMoney = 0;
    let totalPieces = 0;

    // Sushi lines (combos + rolls)
    const sushiEntries = Object.entries(cart)
      .map(([id, qty]) => ({ qty, item: MENU.find(x => x.id === id) }))
      .filter(x => x.item && x.item.pieces > 0)
      .sort((a,b) => (a.item.tab + a.item.name).localeCompare(b.item.tab + b.item.name));

    for (const {qty, item} of sushiEntries){
      const lineMoney = (item.price||0) * qty;
      const itemPieces = (item.pieces||0) * qty;
      totalMoney += lineMoney;
      totalPieces += itemPieces;

      const xBase = item.pieces === 5 ? " x5" : "";
      sushiLines.push(`${qty}x ${item.name}${xBase} â€“ ${itemPieces} piezas â€“ $${fmtMoney(lineMoney)}`);
    }

    // Salsas incluidas (soja fija)
    const includedSoja = countIncludedSoja();

    // Salsas a elecciÃ³n (sin cargo) (solo opciones permitidas)
    const choiceMap = groupChoiceSauces();
    // Filtrar por las 4 opciones (por si algÃºn dÃ­a sumÃ¡s otras)
    const choiceLines = SAUCE_OPTIONS
      .filter(name => choiceMap[name])
      .map(name => `${choiceMap[name]}x ${name} â€“ $0`);

    // Salsas adicionales pagas
    const paidExtras = groupPaidExtras();

    // totalMoney ya incluye extras pagas (porque estÃ¡n en cart)
    // pero todavÃ­a no sumamos los extras al totalMoney si en sushiEntries excluimos pieces==0.
    // Entonces sumamos acÃ¡:
    for (const ex of paidExtras){
      totalMoney += ex.total;
    }

    // totalPieces no incluye extras (pieces==0), bien.

    // Armar mensaje
    let msg = "";
    msg += "Hola Stella Maris Sushi ðŸ£\n\n";
    msg += "Quiero pedir:\n\n";

    msg += "ðŸ£ Sushi:\n";
    msg += (sushiLines.length ? sushiLines.join("\n") : "â€”") + "\n\n";

    msg += "ðŸ¥£ Salsas:\n\n";

    msg += "Salsa incluida (sin cargo):\n";
    msg += (includedSoja > 0 ? `${includedSoja}x Salsa de soja â€“ $0\n\n` : "â€”\n\n");

    msg += "Salsa a elecciÃ³n (sin cargo):\n";
    msg += (choiceLines.length ? choiceLines.join("\n") + "\n\n" : "â€”\n\n");

    msg += "Salsa adicional:\n";
    if(paidExtras.length){
      msg += paidExtras.map(ex => `${ex.qty}x ${ex.name} â€“ $${fmtMoney(ex.total)}`).join("\n") + "\n\n";
    } else {
      msg += "â€”\n\n";
    }

    msg += `Total de piezas: ${totalPieces}\n`;
    msg += `Total: $${fmtMoney(totalMoney)}\n\n`;
    msg += "Retiro en el local.";

    return msg;
  }

  function sendWA(){
    if (Object.keys(cart).length === 0){
      alert("AgregÃ¡ algo al pedido ðŸ™‚");
      return;
    }
    const msg = buildMessage();
    const url = `https://wa.me/${WA}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  }

  function cardHTML(item){
    const price = item.price ? `$${fmtMoney(item.price)}` : "â€”";
    const qty = getQty(item.id);

    const hasImg = !!item.img;
    const imgBlock = hasImg
      ? `<div class="imgBox" onclick="openImgModal('${escapeQuotes(item.name)}','${escapeQuotes(item.img)}')">
           <div class="tapHint">TocÃ¡ para agrandar</div>
           <img src="${item.img}" alt="${item.name}">
         </div>`
      : `<div class="imgBox">Foto (pendiente)</div>`;

    const base = (item.pieces === 5) ? "x5 piezas" : (item.pieces > 0 ? `${item.pieces} piezas` : "Unidad");

    const desc = item.tab === "combos"
      ? `<div class="meta"><b>${base}</b></div>
         ${(item.composition && item.composition.length) ? `<ul class="list">${item.composition.map(x=>`<li>${x}</li>`).join("")}</ul>` : ""}`
      : `<div class="meta"><b>${base}</b> Â· ${item.desc || ""}</div>`;

    return `
      <div class="card" data-tab="${item.tab}">
        <div class="priceTag">${price}</div>
        ${imgBlock}
        <div class="body">
          <p class="name">${item.name}</p>
          ${desc}
          <div class="bottomRow">
            <div class="qty">En tu pedido: <span class="qtyPill" id="qty-${item.id}">${qty}x</span></div>
            <div class="btns">
              <button class="btn minus" onclick="sub('${item.id}')">â€“</button>
              <button class="btn add" onclick="add('${item.id}')">Agregar</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function render(){
    const root = document.getElementById("content");
    const items = MENU.filter(x => x.tab === activeTab);

    const title = activeTab === "combos"
      ? "COMBOS"
      : (activeTab === "rolls" ? "ROLLS" : "SALSAS");

    root.innerHTML = `
      <div class="sectionTitle">${title}</div>
      <div class="grid">
        ${items.map(cardHTML).join("")}
      </div>
    `;

    updateTotals();
    updateQtyPills();
  }

  document.getElementById("btnClear").addEventListener("click", clearCart);
  document.getElementById("btnWA").addEventListener("click", sendWA);

  render();
</script>
</body>
</html>
